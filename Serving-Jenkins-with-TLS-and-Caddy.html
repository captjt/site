<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Serving Jenkins with TLS-Encryption Using Caddy</title>
    <meta name="description" content="Ushering In Growth - My development story begins here." />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Ushering In Growth" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Ushering In Growth" />
    <meta property="og:description" content="My development story begins here." />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Ushering In Growth" />
    <meta name="twitter:description" content="My development story begins here." />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Ushering In Growth",
    "url": "/",
    "image": "/assets/images/cover1.jpg",
    "description": "My development story begins here."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Ushering In Growth" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-projects " role="presentation"><a href="/projects">Projects</a></li>
        <li class="nav-technologies " role="presentation"><a href="/tag/technologies">Technlogoies</a></li>
        <!--<li class="nav-speeches " role="presentation"><a href="/tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/fiction">Fiction</a></li>-->
        <li class="nav-author " role="presentation"><a href="/author/jt">Author</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/encryption.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/logo.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-content tag-technologies">

        <header class="post-header">
            <h1 class="post-title">Serving Jenkins with TLS-Encryption Using Caddy</h1>
            <section class="post-meta">
            <!-- <a href='/'>Jordan Taylor</a> -->
            <time class="post-date" datetime="2017-01-27">27 Jan 2017</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/tag/technologies'>Technologies</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <h2 id="what-is-caddy">What is Caddy?</h2>

<p>Caddy, or as others may know Caddyserver, is a web server similar to nginx or Apache that serves files over HTTP. HTTP is the basic and standard way people are served/distributed website content. Caddy’s main purpose is to streamline how developers authenticate their web deployment process. It is the only web server software that will automatically encrypt your site with SSL/TLS encryption. This means that without too much knowledge behind web security and how to secure your server - developers can receive and authenticate TLS certifications automatically. We are in the age of many, many technologies throughout the full stack of web development it is hard to keep up with everything outside of development processes. Caddy is here to save us from the cumbersome process of deploying our applications properly AND with encryption included.</p>

<h2 id="caddy-has-options">Caddy Has Options</h2>

<p>Other than the automatic TLS encryption, one of the coolest things the community around Caddy has been developing is “Directives”. These can be thought of as plugins or extensions to make developer’s lives even more easy. Things like file JWT authentication, CORS (Cross Origin Resource Sharing), AWS Lambda features, and others right out of these easily configured extensions.</p>

<h2 id="serving-jenkins-with-caddy">Serving Jenkins With Caddy</h2>

<p>Because Caddy is such an amazing software product I tend to lean more towards using it everywhere I can. With that being said, I did find it a bit quirky when settings it up to serve a CI/CD application – Jenkins.</p>

<p>Jenkins is a fantastic open source product that has been a leader in the CI/CD community ever since being released as the first one of it’s kind. It’s a Java based project that when configured properly can do some pretty robust pipelining and custom build processes. I will not go over how to setup Jenkins on your machine there are some fantastic resources already out there on this kind of thing – but <a href="https://trycrmr.github.io/hubpress.io/2017/01/20/Automated-Testing-Using-Jenkins-on-AWS.html">here</a> is a great walk through on how to setup Jenkins on CentOS 7 in your AWS environment.</p>

<h2 id="caddy">Caddy</h2>

<p>Caddy comes out with releases on a regular basis this download version might not be up to date, but I will try to keep this as up to date as possible with newer things that change with Caddy and/or Jenkins when configuring the two together.</p>

<h2 id="initial-install">Initial Install</h2>

<p>Download the tarball for the release of caddy you want. <strong>NOTE:</strong> You can also do this from their site @ <a href="https://www.caddyserver.com">caddyserver</a> and hand jam a custom built Caddy + directives over to your server.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wget https://caddyserver.com/download/builds/172401104141966/caddy_linux_amd64_custom.tar.gz
tar xf caddy_linux_amd64_custom.tar.gz
</code></pre>
</div>

<p>We are going to need to copy our <code class="highlighter-rouge">caddy</code> binary to our local/bin to be in our executable PATH. After that we will need to change the owner of the binary to <code class="highlighter-rouge">root</code> so that we can enable a <em>system service</em> to start/stop/restart/etc. our caddy server.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo cp caddy /usr/local/bin/
sudo chown root:root /usr/local/bin/caddy
sudo chmod 755 /usr/local/bin/caddy
</code></pre>
</div>

<h2 id="configuring-caddy-and-groupsusers">Configuring Caddy and Groups/Users</h2>

<p>This will setup Caddy to be able to bind to our HTTP and SSL ports without being <code class="highlighter-rouge">root</code>. <strong>Don’t forget to configure the firewalls on your server to allow for traffic through both ports 80 and 433.</strong> This is easily done in AWS through security groups and on the CentOS server through <em>firewalld</em>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo setcap <span class="s1">'cap_net_bind_service=+ep'</span> /usr/local/bin/caddy
</code></pre>
</div>

<p>We then need to setup the group, user and directories that Caddy will need to have.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo groupadd -g 33 www-data
sudo useradd <span class="se">\</span>
  -g www-data --no-user-group <span class="se">\</span>
  --home-dir /var/www --no-create-home <span class="se">\</span>
  --shell /usr/sbin/nologin <span class="se">\</span>
  --system --uid 33 www-data

sudo mkdir /etc/caddy
sudo chown -R root:www-data /etc/caddy
sudo mkdir /etc/ssl/caddy
sudo chown -R www-data:root /etc/ssl/caddy
sudo chmod 0770 /etc/ssl/caddy
</code></pre>
</div>

<h2 id="the-caddyfile">The Caddyfile</h2>

<p>Sample Caddyfile with subdomain wildcard (*.jt.codes)</p>

<p>This will proxy all of the root traffic from port 80 to port 8080 where our Jenkins application is running – while passing the host information that most backend applications would expect when we specify <code class="highlighter-rouge">transparent</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>jenkins.jt.codes {
	proxy / :8080 {
		transparent
	}
}
</code></pre>
</div>

<p>We need to next move our Caddyfile and give it proper ownership to be used. <strong>NOTE:</strong> I like to keep my Caddyfile in my <code class="highlighter-rouge">$HOME</code> directory so it’s easily found/changed in the future - just make sure you copy the Caddyfile into the <code class="highlighter-rouge">/etc/caddy/</code> directory if you alter it again and restart the service.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo cp /path/to/Caddyfile /etc/caddy/
sudo chown www-data:www-data /etc/caddy/Caddyfile
sudo chmod 444 /etc/caddy/Caddyfile
</code></pre>
</div>

<h2 id="note-serving-from-varwww">Note Serving from <strong>/var/www/</strong></h2>

<p>If we wanted to host our sites inside of a home directory similar to how <em>nginx and Apache</em> do we can also configure an <code class="highlighter-rouge">/var/www/</code> site as well. Although because we are just going to reverse proxy to our running Jenkins application on <strong>port 8080</strong> we will not have to serve content through that configuration.</p>

<h2 id="caddy-as-a-service">Caddy as a Service</h2>

<p>One thing we wanted to make sure we had is a Caddy systemd service configuration – so next we will configure a <code class="highlighter-rouge">caddy.service</code> file. Similar to our Caddyfile I like to keep a reference file in my $HOME directory to easily change and configure anything again.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">cd</span> <span class="nv">$HOME</span>
<span class="gp">$ </span>vim caddy.service
</code></pre>
</div>

<p>and inside of our <code class="highlighter-rouge">caddy.service</code> file we will paste this …</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
Description=Caddy HTTP/2 web server
Documentation=https://caddyserver.com/docs
After=network-online.target
Wants=network-online.target systemd-networkd-wait-online.service

[Service]
Restart=on-failure
StartLimitInterval=86400
StartLimitBurst=5

; User and group the process will run as.
User=www-data
Group=www-data

; Letsencrypt-issued certificates will be written to this directory.
Environment=CADDYPATH=/etc/ssl/caddy

; Always set "-root" to something safe in case it gets forgotten in the Caddyfile.
ExecStart=/usr/local/bin/caddy -log stdout -agree=true -conf=/etc/caddy/Caddyfile -root=/var/tmp
ExecReload=/bin/kill -USR1 $MAINPID

; Limit the number of file descriptors; see `man systemd.exec` for more limit settings.
LimitNOFILE=1048576
; Unmodified caddy is not expected to use more than that.
LimitNPROC=64

; Use private /tmp and /var/tmp, which are discarded after caddy stops.
PrivateTmp=true
; Use a minimal /dev
PrivateDevices=true
; Hide /home, /root, and /run/user. Nobody will steal your SSH-keys.
ProtectHome=true
; Make /usr, /boot, /etc and possibly some more folders read-only.
ProtectSystem=full
; … except /etc/ssl/caddy, because we want Letsencrypt-certificates there.
;   This merely retains r/w access rights, it does not add any new. Must still be writable on the host!
ReadWriteDirectories=/etc/ssl/caddy

; The following additional security directives only work with systemd v229 or later.
; They further retrict privileges that can be gained by caddy. Uncomment if you like.
; Note that you may have to add capabilities required by any plugins in use.
;CapabilityBoundingSet=CAP_NET_BIND_SERVICE
;AmbientCapabilities=CAP_NET_BIND_SERVICE
;NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
</code></pre>
</div>

<p>A couple things to note when we are looking at that configuration file - we are going to store our SSL certificates inside of the <code class="highlighter-rouge">/etc/ssl/caddy</code> directory. <strong>Make sure you keep these certificates secure and backed up.</strong></p>

<p>Caddy will auto detect when our certificates need to be renewed but we must make sure we do keep them secure from people.</p>

<h2 id="onto-the-magic">Onto the Magic</h2>

<p><strong>A quick note:</strong> make sure inside of your <strong>Jenkins &gt; Configure System</strong> you setup your <code class="highlighter-rouge">Jenkins URL</code> to the “<em>https</em>” version of your domains. So for us it will be “<em>https://jenkins.jt.codes</em>”.</p>

<p><strong>NOTE:</strong> make sure to add the “s” after “http” – this will through reverse proxy issues with the Jenkins application.</p>

<p>We are going to copy our <code class="highlighter-rouge">caddy.service</code> file to the <code class="highlighter-rouge">system</code> directory, establish proper ownership/permissions and start out Caddy service.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo cp caddy.service /etc/systemd/system/
sudo chown root:root /etc/systemd/system/caddy.service
sudo chmod 744 /etc/systemd/system/caddy.service
sudo systemctl daemon-reload
sudo systemctl start caddy.service
</code></pre>
</div>

<p>To allow for the Caddy service to start on reboot we can <code class="highlighter-rouge">enable</code> it.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo systemctl <span class="nb">enable </span>caddy.service
</code></pre>
</div>

<p>The service works just like any other <code class="highlighter-rouge">systemd</code> service and we can <strong>start, restart, and stop</strong> - along with seeing the status of the running service with <strong>status</strong>.</p>

<h2 id="going-forward">Going Forward</h2>

<p>Once you verified and established that your Jenkins server is now SSL encrypted - you can dance around for a second. I must say Caddy has been a huge savior when it comes to getting an application out there and secured properly. You can find Caddy on github @ <a href="https://github.com/mholt/caddy">Caddy</a> or <a href="https://github.com/caddyserver">caddyserver</a>’s Organization.</p>

<p>HUGE S/o to <a href="https://github.com/mholt">Matt Holt</a> for doing some amazing things and creating this awesome tech.</p>

<p>I will put out more examples and resources on Caddy, the ACME protocol and how to use Caddy with other types of applications.</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/jt" style="background-image: url(/assets/images/kube-gopher.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/jt">Jordan Taylor</a></h4>
                
                
                    <p> Software Engineer. DC. Radford Baseball Alum.</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Viringia, USA</span> 
                    <span class="author-link icon-link"><a href="http://jt.codes/"> jt.codes</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Serving Jenkins with TLS-Encryption Using Caddy&amp;url=http://jt.codes/Serving-Jenkins-with-TLS-and-Caddy"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://jt.codes/Serving-Jenkins-with-TLS-and-Caddy"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://jt.codes/Serving-Jenkins-with-TLS-and-Caddy"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/pipelines.jpg)" href="/Jenkins-2.0-Pipeline-NodeJS">
            <section class="post">
                <h2>Jenkins 2.0 - Pipelines with NodeJS</h2>
                <p>## Future of Jenkins: The Jenkinsfile The future of Jenkins and CI/CD is having "Pipelines"...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/Settings-Up-Python-Environment-VS-Code">
            <section class="post">
                <h2>Python & VS Code</h2>
                <p>Working With VS Code There are a lot of IDE/Editors out there for Python and...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Ushering In Growth</a> &copy; 2017</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-81287416-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
